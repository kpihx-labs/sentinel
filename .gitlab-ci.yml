stages:
  - deploy
  - sync

deploy_homelab:
  stage: deploy
  tags:
    - homelab 
  only:
    - main     # Se lance uniquement quand on push sur la branche main
  script:
    - echo "ðŸš€ DÃ©marrage du dÃ©ploiement sur le Homelab..."
    
    # 1. On recrÃ©e le fichier .env avec les secrets stockÃ©s dans GitLab
    - echo "TELEGRAM_TOKEN=$TELEGRAM_TOKEN" >> .env
    - echo "CHAT_ID=$CHAT_ID" >> .env
    
    # On ajoute le proxy (hÃ©ritÃ© des variables de groupe si configurÃ©, sinon on le force ici par sÃ©curitÃ©)
    # - echo "http_proxy=http://129.104.201.11:8080" >> .env
    # - echo "https_proxy=http://129.104.201.11:8080" >> .env
    
    # 2. Lancement de Docker Compose
    # Le runner exÃ©cute Ã§a directement sur ton serveur
    - docker compose up -d --build --remove-orphans
    
    # 3. Nettoyage des vieilles images pour ne pas saturer le disque
    - docker image prune -f
    
    - echo "âœ… DÃ©ploiement terminÃ© ! Application accessible."

sync_github:
  stage: sync
  variables:
    GITHUB_ORG: "kpihx-labs"
    REPO_NAME: "wa-bot"
  only:
    - main
  script:
    - echo "ðŸ”„ Synchronisation vers GitHub..."
    # Appel Ã  l'API GitHub pour crÃ©er le repo (ignorera si dÃ©jÃ  prÃ©sent grÃ¢ce au "|| true")
    - |
      curl -H "Authorization: token ${GITHUB_TOKEN}" \
           -X POST \
           -d "{\"name\":\"${REPO_NAME}\", \"private\":false}" \
           https://api.github.com/orgs/${GITHUB_ORG}/repos || true
    
    - echo "ðŸ”„ Synchronisation..."
    - git remote add github https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_ORG}/${REPO_NAME}.git || git remote set-url github https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_ORG}/${REPO_NAME}.git
    - git push github main --force