stages:
  - deploy
  - sync

deploy_homelab:
  stage: deploy
  tags:
    - homelab 
  only:
    - main     # Se lance uniquement quand on push sur la branche main
  script:
    - echo "üöÄ D√©marrage du d√©ploiement sur le Homelab..."
    
    # 1. On recr√©e le fichier .env avec les secrets stock√©s dans GitLab
    - echo "TELEGRAM_TOKEN=$TELEGRAM_TOKEN" >> .env
    - echo "CHAT_ID=$CHAT_ID" >> .env
    
    # On ajoute le proxy (h√©rit√© des variables de groupe si configur√©, sinon on le force ici par s√©curit√©)
    # - echo "http_proxy=http://129.104.201.11:8080" >> .env
    # - echo "https_proxy=http://129.104.201.11:8080" >> .env
    
    # 2. Lancement de Docker Compose
    # Le runner ex√©cute √ßa directement sur ton serveur
    - docker compose up -d --build --remove-orphans
    
    # 3. Nettoyage des vieilles images pour ne pas saturer le disque
    - docker image prune -f
    
    - echo "‚úÖ D√©ploiement termin√© ! Application accessible."

sync_github:
  stage: sync
  variables:
    GITHUB_ORG: "kpihx-labs"
    REPO_NAME: "sentinel"
  only:
    - main
  script:
    - echo "üîç V√©rification/Cr√©ation du repo sur GitHub..."
    - |
      curl -H "Authorization: token ${GITHUB_TOKEN}" \
           -X POST \
           -d "{\"name\":\"${REPO_NAME}\", \"private\":false}" \
           https://api.github.com/orgs/${GITHUB_ORG}/repos || true
    
    - echo "üîÑ Synchronisation..."
    # On s'assure que le remote est bien configur√©
    - git remote add github https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_ORG}/${REPO_NAME}.git || git remote set-url github https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_ORG}/${REPO_NAME}.git
    
    # Correction ici : on pousse explicitement le SHA actuel vers la branche main distante
    - git push github $CI_COMMIT_SHA:refs/heads/main --force